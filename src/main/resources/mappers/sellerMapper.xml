<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="SellerMapper">
    <select id="getSellers" resultType="map">
    	<!-- 이중조인해서 결제금을 이용해 판매자별 총매출불러오고 format으로 1000단위 구분함. -->
    <!-- 관리자 총매출 구하기전
         SELECT s.seller_num, s.seller_storeName, s.seller_name,
       	 FORMAT(SUM(o.order_pay), 0) AS total_revenue,
         FORMAT(floor(sum(o.order_pay) * 0.05), 0) as fee,
         FORMAT(SUM(o.order_pay) - floor(sum(o.order_pay) * 0.05), 0) as settlement_amount
         FROM seller s
         LEFT JOIN item i ON s.seller_num = i.seller_num
         LEFT JOIN orders o ON i.item_num = o.item_num
         WHERE s.seller_num != 'admin'
         GROUP BY s.seller_num, s.seller_id, s.seller_name;   
    -->
   		 SELECT s.seller_num, s.seller_storeName, s.seller_name,
       	 FORMAT(SUM(o.order_pay), 0) AS total_revenue,
         FORMAT(floor(sum(o.order_pay) * 0.05), 0) as fee,
         FORMAT(SUM(o.order_pay) - floor(sum(o.order_pay) * 0.05), 0) as settlement_amount,
         
         FORMAT((SELECT SUM(o.order_pay) FROM orders o
               INNER JOIN item i ON i.item_num = o.item_num
               INNER JOIN seller s ON s.seller_num = i.seller_num
               WHERE s.seller_num != 'admin'), 0) as grand_total_revenue,
         FORMAT((SELECT SUM(floor(o.order_pay * 0.05)) FROM orders o
               INNER JOIN item i ON i.item_num = o.item_num
               INNER JOIN seller s ON s.seller_num = i.seller_num
               WHERE s.seller_num != 'admin'), 0) as grand_fee,
         FORMAT((SELECT SUM(o.order_pay) - SUM(floor(o.order_pay * 0.05)) FROM orders o
               INNER JOIN item i ON i.item_num = o.item_num
               INNER JOIN seller s ON s.seller_num = i.seller_num
               WHERE s.seller_num != 'admin'), 0) as grand_settlement_amount
         
         FROM seller s
         LEFT JOIN item i ON s.seller_num = i.seller_num
         LEFT JOIN orders o ON i.item_num = o.item_num
         WHERE s.seller_num != 'admin'
         GROUP BY s.seller_num, s.seller_id, s.seller_name;
    </select>
    
<!--     가맹점 관리 -->
    <select id="getSeller" resultType="map">
    select * from seller;
    </select>
    
    <update id="approveSellerStatus" parameterType="list">
    update seller
    set seller_recoYn = 'Y'
    where seller_num in 
    <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
        #{item}
    </foreach>
</update>

<update id="rejectSellerStatus" parameterType="list">
    update seller
    set seller_recoYn = 'N'
    where seller_num in 
    <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
        #{item}
    </foreach>
</update>
    
    
	<!-- 상품 등록 -->
    <insert id="itemInsert">
	    INSERT INTO item (
	        category_num,
	        item_name,
	        item_price,
	        item_mainImg,
	        item_detail,
	        item_register
	    )
	    VALUES (
	        #{category_num},
	        #{item_name},
	        #{item_price},
	        #{item_mainImg},
	        #{item_detail},
	        now()
	    )
	</insert>

    <!-- 상품전체 가져오기  -->
    <select id="getItems" resultType="map">
    	SELECT *
    	FROM item
    </select>

	<!-- 개별상품 가져오기  -->
	<select id="getItem" resultType="map">
	    SELECT *
	    FROM item
	    WHERE item_num = #{item_num}
	    LIMIT 1
	</select>
	    
      <!--월별 판매량 가져오기  -->
    <select id="getSales" resultType="map">
    	SELECT s.seller_num, s.seller_storeName, s.seller_name,
       	DATE_FORMAT(o.order_day, '%Y-%m') as order_month,
       	FORMAT(SUM(o.order_pay), 0) AS total_revenue,
       	FORMAT(floor(sum(o.order_pay) * 0.05), 0) as fee,
       	FORMAT(SUM(o.order_pay) - floor(sum(o.order_pay) * 0.05), 0) as settlement_amount,
      	st.settlement_yn
		FROM seller s
		LEFT JOIN item i ON s.seller_num = i.seller_num
		LEFT JOIN orders o ON i.item_num = o.item_num
		LEFT JOIN settlement st ON s.seller_num = st.seller_num
		WHERE s.seller_num != 'admin'
		GROUP BY s.seller_num, s.seller_id, s.seller_name, order_month, st.settlement_yn
		ORDER BY order_month;
    </select>
   <!-- 정산작업 아직 미완성구문 -->
<update id="updateSettlementYn" parameterType="map">
     UPDATE settlement st
    SET st.settlement_yn = 'Y'
    WHERE st.seller_num IN
    (
        SELECT s.seller_num
        FROM seller s
        WHERE s.seller_num IN
        (
            <foreach collection="sellerNums" item="sellerNum" open="(" close=")" separator=",">
                #{sellerNum}
            </foreach>
        )
    )
    AND EXISTS
    (
        SELECT 1
        FROM orders o
        JOIN item i ON o.item_num = i.item_num
        WHERE i.seller_num = st.seller_num
        AND DATE_FORMAT(o.order_day, '%Y-%m') = #{orderMonth}
    );
</update>

	<!-- 일별 판매량 가져오기 -->
	<select id="daySales" resultType="map" parameterType="map">
		SELECT s.seller_num, s.seller_storeName, s.seller_name,
		DATE_FORMAT(o.order_day, '%Y-%m') as order_month,
    	DATE_FORMAT(o.order_day, '%Y-%m-%d') as order_day,
       	FORMAT(o.order_pay, 0) as revenue,
       	FORMAT(floor((o.order_pay) * 0.05), 0) as fee,
       	FORMAT((o.order_pay) - floor((o.order_pay) * 0.05), 0) as income
		FROM seller s
		LEFT JOIN item i ON s.seller_num = i.seller_num
		LEFT JOIN orders o ON i.item_num = o.item_num
		LEFT JOIN settlement st ON s.seller_num = st.seller_num
		WHERE s.seller_num != 'admin'
		AND s.seller_num = #{sellerNum} <!-- s.seller_num을 필터링하기 위해 추가된 부분 -->
    	AND DATE_FORMAT(order_day, '%Y-%m') = #{orderMonth} 
		GROUP BY s.seller_num, s.seller_id, s.seller_name, order_day,order_pay
		ORDER BY order_day
		;
	</select>
	
	<!--판매자별 연간판매량전체-->
	<select id="yearSales" resultType="map" parameterType="map">
	 	SELECT s.seller_num, s.seller_name,
       	DATE_FORMAT(o.order_day, '%Y-%m') as order_month,
      	FORMAT(SUM(o.order_pay), 0) AS revenue,
       	FORMAT(floor(sum(o.order_pay) * 0.05), 0) as fee,
       	FORMAT(SUM(o.order_pay) - floor(sum(o.order_pay) * 0.05), 0) as income
		FROM seller s
		LEFT JOIN item i ON s.seller_num = i.seller_num
		LEFT JOIN orders o ON i.item_num = o.item_num
		LEFT JOIN settlement st ON s.seller_num = st.seller_num
		WHERE s.seller_num != 'admin'
		AND s.seller_num = #{sellerNum}
		GROUP BY s.seller_num, s.seller_name, order_month
		ORDER BY order_month;
	</select>
	
	
	
	
</mapper>